name: Build and Deploy to Artifact Registry

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags

env:
  PROJECT_ID: lema-dev
  REGION: us-west1
  REPOSITORY: oumi-pypi

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: "Set up Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel twine build

    - name: Build package
      run: python -m build

    - id: 'gcp_auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        workload_identity_provider: 'projects/356780097663/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        service_account: 'umi-pypi-writer@lema-dev.iam.gserviceaccount.com'

    - name: Deploy to Artifact Registry
      env:
        TWINE_USERNAME: oauth2accesstoken
        TWINE_PASSWORD: ${{ steps.gcp_auth.outputs.access_token }}
      run: |
        twine upload --repository-url https://${{ env.REGION }}-python.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/ dist/*
