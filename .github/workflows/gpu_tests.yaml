name: "GPU Tests"

on:
  schedule:
    - cron: '0 */8 * * *' # Every 8 hours
  workflow_dispatch:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'notebooks/**'
      - 'configs/**'
      - 'scripts/**'
      - 'README.md'

jobs:
  gpu-tests:
    permissions:
      contents: 'read'
    runs-on: linux-gpu-runner

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        # Checkout using commit hash to make "no-commit-to-branch" test pass.
        ref: ${{ github.sha }}

    - name: Install uv
      uses: astral-sh/setup-uv@v2
      with:
        enable-cache: true
        cache-dependency-glob: "pyproject.toml"

    - name: "Set up Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        # Install in system python as we're in a sandbox env
        # Install in verbose mode to see what's going on
        uv pip install -e '.[ci_gpu]' hf_transfer --system

    - name: Download Test Data
      run: |
        ./tests/scripts/predownload_for_github_gpu_tests.sh

    - name: Set CUDA_HOME
      run: |
        # Find CUDA installation
        if [ -d "/usr/local/cuda" ] && [ -f "/usr/local/cuda/bin/nvcc" ]; then
          echo "CUDA_HOME=/usr/local/cuda" >> $GITHUB_ENV
        elif [ -d "/opt/cuda" ] && [ -f "/opt/cuda/bin/nvcc" ]; then
          echo "CUDA_HOME=/opt/cuda" >> $GITHUB_ENV
        elif command -v nvcc &> /dev/null; then
          NVCC_PATH=$(which nvcc)
          CUDA_PATH=$(dirname $(dirname $NVCC_PATH))
          echo "CUDA_HOME=$CUDA_PATH" >> $GITHUB_ENV
        else
          # Try to find CUDA in common locations
          for cuda_dir in /usr/local/cuda-* /opt/cuda-*; do
            if [ -d "$cuda_dir" ] && [ -f "$cuda_dir/bin/nvcc" ]; then
              echo "CUDA_HOME=$cuda_dir" >> $GITHUB_ENV
              break
            fi
          done
        fi

        # Verify CUDA_HOME is set
        if [ -z "$CUDA_HOME" ]; then
          echo "Warning: CUDA_HOME not found, setting to /usr/local/cuda as fallback"
          echo "CUDA_HOME=/usr/local/cuda" >> $GITHUB_ENV
        fi

        echo "CUDA_HOME set to: $CUDA_HOME"

    - name: Run GPU tests
      run: |
        nvidia-smi
        echo "CUDA_HOME: $CUDA_HOME"

        # Verify nvcc is available
        if [ -f "$CUDA_HOME/bin/nvcc" ]; then
          echo "Found nvcc at: $CUDA_HOME/bin/nvcc"
          $CUDA_HOME/bin/nvcc --version
        else
          echo "nvcc not found at $CUDA_HOME/bin/nvcc"
          find /usr -name "nvcc" 2>/dev/null | head -5 || true
        fi

        cd ./tests/integration/
        pytest -s -m "not e2e and not e2e_eternal and not multi_gpu" --durations=50 --timeout=300
