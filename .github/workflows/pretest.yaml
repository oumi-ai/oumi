name: "Pre-review Tests"

on: [pull_request]

jobs:
  static-checks:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        # Checkout using commit hash to make "no-commit-to-branch" test pass.
        ref: ${{ github.sha }}

    - name: Setup Python
      uses: actions/setup-python@v5
      id: setup-python
      with:
        python-version: '3.11'

    - name: Setup LeMa Dependencies
      run: |
        set -e  # Exit if any command failed
        python -m pip install uv
        # Install in system python as we're in a sandbox env
        # Install in verbose mode to see what's going on
        uv pip install -e '.[all]' --system -v

    - name: Cache pre-commit
      uses: actions/cache@v3
      with:
        path: ~/.cache/pre-commit
        key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

    - name: Check LeMa Pre-commit rules
      run: |
        pre-commit run --all-files --show-diff-on-failure

    - name: Run LeMa Tests
      run: |
        cd ./tests/
        pytest -s
