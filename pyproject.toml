[build-system]
requires = ["setuptools>=64", "setuptools_scm>=8"]
build-backend = "setuptools.build_meta"

[tool.setuptools.package-data]
lema = ["LICENSE", "README.md", "*.jinja"]

[tool.setuptools_scm]
# default scm config.

[tool.setuptools]
# default setuptools config.


[project]
name = "lema"
dynamic = ["version"]
readme = "README.md"
requires-python = ">=3.8"
description = "Learning Machines - Modeling Platform"
authors = [{ name = "LeMa Team", email = "contact@openlema.com" }]
classifiers = [
    "Programming Language :: Python :: 3",
    "Operating System :: OS Independent",
    "Development Status :: 3 - Alpha",
]

dependencies = [
    "google-api-python-client",    # To enable GCP in Skypilot
    "numpy",
    "pexpect",
    "skypilot[gcp,lambda,runpod]",
    "torch",
    "transformers",
]

[project.urls]
Homepage = "https://github.com/openlema/lema"
Issues = "https://github.com/openlema/lema/issues"

[project.optional-dependencies]
dev = [
    "black",
    "isort",
    "mypy",
    "pre-commit",
    "pyright",
    "pytest",
    "ruff",
    "torchfix",
]
train = [
    "accelerate",
    "bitsandbytes",                 # for quantization
    "datasets",
    "deepspeed",
    "lm-eval",
    "omegaconf",
    "peft",
    "pydantic>=2",
    "pynvml",
    "safetensors",
    "sentencepiece",                # for phi-3
    "tensorboard",
    "torchdata>=0.8.0",
    "transformers>=4.43.1,<4.44.0",
    "trl>=0.9.0",
    "wandb",
]
cloud = [
    "google-api-core>=2.19.0",
    "google-auth>=2.30.0",
    "google-cloud-core>=2.4.1",
    "google-cloud-storage>=2.17.0",
]
gpu = ["flash-attn", "liger-kernel"] # dependecies that require a GPU to install
docs = ["myst_parser", "nbsphinx", "sphinx", "sphinx-rtd-theme"]
all = ["lema[dev,train,cloud,docs]"]

[project.scripts]
lema-evaluate = "lema.evaluate:main"
lema-infer = "lema.infer:main"
lema-launch = "lema.launch:main"
lema-train = "lema.train:main"

[tool.ruff]
line-length = 88
extend-include = ["*.ipynb"] # Include ipython notebooks

[tool.ruff.lint]
select = [
    "F",   # pyflakes: detect various errors
    "E",   # pycodestyle: errors
    "W",   # pycodestyle: warnings
    "I",   # isort: check import order
    "D",   # pydocstyle: check docstring style
    "TID", # flake8-tidy-imports: check import tidiness
    "NPY", # NumPy-specific rules
]
ignore = [
    "D100",   # Missing docstring in public module, temporary, OPE-326
    "D101",   # Missing docstring in public class, temporary, OPE-326
    "NPY002", # Replace legacy numpy aliases
]

[tool.ruff.lint.flake8-tidy-imports]
# Disallow all relative imports.
ban-relative-imports = "all"

[tool.ruff.lint.per-file-ignores]
"tests/*" = ["D"] # Ignore docstring checks in tests

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.ruff.lint.isort]
known-first-party = ["lema"]

[tool.pyright]
include = ["src/lema/**", "tests/**"]
exclude = ["src/lema/experimental/**"]
typeCheckingMode = "basic"
pythonVersion = "3.8"
pythonPlatform = "All"                 # Include linux, mac, windows

reportPrivateImportUsage = "none"

[tool.pytest.ini_options]
testpaths = ["tests"]
