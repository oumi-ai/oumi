# Sample command:
# sky launch --cloud GCP -i 10 --env OUMI_RUN_NAME=pretokenize.v01 --num-nodes 1 --no-use-spot --cluster xrdaukar-cpu-01-oumi-cluster src/experimental/pretokenize/sky.yaml

name: pretokenize-example

resources:
  cpus: "32+"
  memory: "64+"
  disk_size: 200  # Disk size in GB
  region: europe-west4

  any_of:
    - use_spot: false

# Upload working directory to remote ~/sky_workdir.
workdir: .

# Mount local files.
file_mounts:
  ~/.netrc: ~/.netrc # WandB credentials

  /dataset_parent_dir:
    source: gs://oumi-dev-europe-west4/
    store: gcs
    mode: MOUNT

envs:
  OUMI_RUN_NAME: pretokenize

setup: |
  set -e
  pip install 'oumi[train]'

run: |
  set -e  # Exit if any command failed.
  source ./configs/skypilot/sky_init.sh

  export INPUT_DATA="/dataset_parent_dir/datasets/fineweb-edu/sample-10BT"
  echo "INPUT_DATA: $INPUT_DATA. Content: $(ls -l $INPUT_DATA)"
  echo "${INPUT_DATA}: $(ls -l ${INPUT_DATA})"
  echo "${INPUT_DATA}/train: $(ls -l ${INPUT_DATA}/train)"

  export OUTPUT_DATA="/dataset_parent_dir/datasets/fineweb-edu/hf_pretokenized-sample-10BT"

  set -x # Enable command tracing.
  mkdir -p "$OUTPUT_DATA/train"
  cp -r ${INPUT_DATA}/**.json ${OUTPUT_DATA}
  python3 ./src/experimental/pretokenize/tokenize_dataset.py \
    --verbose \
    --target_col text \
    --input_dataset "${INPUT_DATA}/train/" \
    --output_dir "${OUTPUT_DATA}/train/" \
    --config ./configs/oumi/llama2b.pt.yaml \

  echo "Node ${SKYPILOT_NODE_RANK} is all done!"
